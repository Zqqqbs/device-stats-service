# Device Stats Service

## Описание проекта

Сервис для учёта и анализа данных устройств. Позволяет добавлять данные устройств и получать аналитику за всё время или за заданный период. Данные хранятся в базе данных SQLite, а анализ выполняется асинхронно с использованием Celery и Redis. Дополнительно реализована работа с пользователями (необязательная часть ТЗ), позволяющая связывать устройства с пользователями и получать аналитику по пользователям.

Проект разработан в рамках тестового задания на стажировку "ИТ-Старт" и включает:
- REST API на FastAPI с документацией через Swagger UI.
- Асинхронную обработку задач через Celery.
- Нагрузочное тестирование через Locust.
- Хранение данных в SQLite.

## Ссылка на репозиторий

Проект размещён на GitHub. Ссылка на репозиторий:

https://github.com/Zqqqbs/device-stats-service/

## Технологии

- **FastAPI**: для создания REST API.
- **SQLAlchemy**: для работы с базой данных SQLite.
- **Celery**: для асинхронной обработки задач.
- **Redis**: как брокер сообщений и бэкенд для Celery.
- **Locust**: для нагрузочного тестирования.
- **Docker и Docker Compose**: для контейнеризации и упрощения запуска.

## Зависимости

- fastapi==0.68.0
- uvicorn==0.15.0
- sqlalchemy==1.4.23
- pydantic==1.8.2
- celery==5.2.7
- redis==4.0.2
- numpy==1.21.2
- Jinja2==3.0.3
- python-multipart==0.0.9
- locust==2.20.2

## Структура проекта

- `app/` — основная директория приложения:
  - `main.py` — основной файл FastAPI-приложения.
  - `crud.py` — функции для работы с базой данных.
  - `database.py` — настройка базы данных.
  - `models.py` — модели SQLAlchemy.
  - `schemas.py` — Pydantic-схемы для валидации данных.
  - `tasks.py` — асинхронные задачи Celery.
- device_stats.db база данных SQLite.
- `locust/` — директория для файлов, связанных с нагрузочным тестированием:
  - `locustfile.py` — сценарий нагрузочного теста.
  - `locust_load_test_report.html` — HTML-отчёт с результатами тестирования.
- `docker-compose.yml` — конфигурация Docker Compose.
- `Dockerfile` — Dockerfile для сборки контейнеров.
- `requirements.txt` — зависимости проекта.

## Требования

- Установленный [Docker](https://docs.docker.com/get-docker/) и [Docker Compose](https://docs.docker.com/compose/install/).
- (Опционально) Python 3.9+ и виртуальное окружение для запуска Locust локально.

## Установки и запуск
- Убедитесь, что у вас установлены Docker и Docker Compose.
- Запустите сервис с помощью Docker Compose:  docker-compose up --build
- После запуска сервис будет доступен по адресу `http://localhost:8000/docs`.
  
## Эндпоинты API
- **POST /users/**: Добавить пользователя.
- **POST /devices/{device_id}/stats**: Добавить данные устройства.
- **GET /devices/{device_id}/analytics**: Получить аналитику устройства за всё время.
- **GET /devices/{device_id}/analytics/period**: Получить аналитику устройства за период.
- **GET /users/{user_id}/analytics**: Получить агрегированную аналитику пользователя.
- **GET /users/{user_id}/devices-analytics**: Получить аналитику по всем устройствам пользователя.

